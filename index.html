<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pressure Calibration — DKD-R 6-1</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
:root{
  --brand:#1b8f3a; --ink:#0f172a; --muted:#64748b; --bg:#f5f7f5; --card:#ffffff; --line:#dbe7d9;
  --pass:#16a34a; --fail:#dc2626; --warn:#f59e0b; --page:1200px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Sarabun",system-ui,Segoe UI,Tahoma,sans-serif;font-size:16px;line-height:1.5}
.container{max-width:var(--page);margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.row.nowrap{flex-wrap:nowrap;overflow-x:auto}
.row.nowrap>*{flex:0 0 auto}
.row .input{min-width:0}

/* Topbar + Tabs: single line, equal width, no wrap */
.topbar{position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;padding:12px 16px;border-bottom:3px solid #0f4f25}
.top-title{font-weight:700}
.tabs{
  display:grid;
  grid-template-columns:repeat(7, minmax(0,1fr));
  gap:8px; margin-top:10px;
  white-space:nowrap;     /* no wrap */
  overflow-x:auto;        /* scroll if needed */
  scrollbar-width:thin;
}
.tab{appearance:none;border:0;background:#eaf5ed;color:#0b3819;padding:10px 12px;border-radius:999px;font-weight:700;cursor:pointer;text-align:center;white-space:nowrap}
.tab.active{background:#0b3819;color:#fff}
.tab:focus{outline:2px solid #0b3819}

/* Inputs */
label{font-weight:700}
.input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-family:inherit}
.helper{font-size:.9rem;color:var(--muted)}
.btn{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
.btn.dark{background:#0f172a}
.btn.warn{background:var(--warn)}
.btn.fail{background:var(--fail)}
.small{font-size:.9rem;color:var(--muted)}
.sep{border:0;border-top:1px dashed var(--line);margin:14px 0}

/* Dashboard KPI equal cards */
.kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;min-height:98px}
.kpi .n{font-size:1.8rem;font-weight:800}

/* Table */
.table{width:100%;border-collapse:collapse;font-size:.95rem}
.table th,.table td{border-bottom:1px solid #e7efe5;padding:8px 10px;text-align:left;vertical-align:top}
.table th{background:#f2f7f3}

/* Badges */
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.85rem;font-weight:800}
.badge.pass{background:#e8f7ee;color:var(--pass);border:1px solid #bfeacc}
.badge.fail{background:#fee2e2;color:var(--fail);border:1px solid #fecaca}

/* Report blocks */
.blk{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
.label{color:#0b3819;font-weight:700;border-bottom:1px solid #e7efe5;padding-bottom:6px;margin-bottom:6px}
.report-head{display:grid;grid-template-columns:2fr 1fr;gap:12px}
.report-grid{display:grid;gap:12px}
.report-3{grid-template-columns:1fr 1fr 1fr}
.report-2{grid-template-columns:1fr 1fr}

/* Env fields equal & level */
.env-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  align-items:end; /* level */
}
.env-grid label{min-height:22px;display:block}
.env-grid .input{height:44px;line-height:44px}

/* Tags */
.tag-sheet{margin-top:10px}
.tag-list{display:flex;gap:16px;flex-wrap:wrap}
.tag{width:300px;border:2px dashed #0f172a;border-radius:12px;padding:12px}
.tag .h{font-weight:800}
.tag .l{font-size:.9rem}

/* Signatures — keep bottom space for real signatures */
.sig-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:80px}
.sig-box{border-top:1px solid #111;padding-top:8px;text-align:center;min-height:90px}

/* Print only tags */
@media print{
  body *{visibility:hidden}
  .tag-sheet, .tag-sheet *{visibility:visible}
  .tag-sheet{position:absolute;left:0;top:0;width:100%}
}

/* Visibility */
.hidden{display:none !important}
</style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="top-title">Pressure Calibration — DKD-R 6-1</div>
      <div class="tabs" id="nav">
        <button class="tab active" data-page="dashboard">1) Dashboard</button>
        <button class="tab" data-page="setup">2) Calibration Setup</button>
        <button class="tab" data-page="entry">3) Measurement Entry</button>
        <button class="tab" data-page="uncert">4) Uncertainty</button>
        <button class="tab" data-page="report">5) Report</button>
        <button class="tab" data-page="charts">6) Charts</button>
        <button class="tab" data-page="help">7) Guide</button>
      </div>
    </div>
  </div>

  <!-- 1) Dashboard -->
  <div class="container" id="page-dashboard">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="flex:1">
          <input id="searchText" class="input" placeholder="ค้นหา: Model / Serial / เครื่องมือ" />
          <input id="filterDateFrom" type="date" class="input"/>
          <input id="filterDateTo" type="date" class="input"/>
          <select id="filterStatus" class="input">
            <option value="">ทุกสถานะ</option><option>In Progress</option><option>Completed</option><option>Pass</option><option>Fail</option>
          </select>
          <button class="btn" id="btnSearch">ค้นหา/กรอง</button>
        </div>
        <div class="row nowrap">
          <select id="factorySelect" class="input">
            <option value="">เลือกโรงงาน/ลูกค้า</option>
            <option>บริษัท อธิมาตร จำกัด</option>
            <option>บริษัท สุราบางยี่ขัน จำกัด</option>
          </select>
          <button class="btn" id="btnNew">+ สร้างงานใหม่</button>
          <button class="btn ghost" id="btnPrintTag">ออก Tag อุปกรณ์</button>
        </div>
      </div>

      <hr class="sep"/>
      <div class="kpi-grid">
        <div class="kpi"><div class="label">จำนวนงานทั้งหมด</div><div class="n" id="kpi-total">0</div></div>
        <div class="kpi"><div class="label">กำลังดำเนินการ</div><div class="n" id="kpi-progress">0</div></div>
        <div class="kpi"><div class="label">เสร็จสิ้น</div><div class="n" id="kpi-completed">0</div></div>
        <div class="kpi"><div class="label">ผ่าน</div><div class="n" id="kpi-pass">0</div></div>
        <div class="kpi"><div class="label">ไม่ผ่าน</div><div class="n" id="kpi-fail">0</div></div>
      </div>

      <hr class="sep"/>
      <table class="table">
        <thead>
          <tr>
            <th style="width:30px"><input type="checkbox" id="chkAll"></th>
            <th>Factory</th><th>Instrument</th><th>Serial</th><th>Range</th><th>Status</th><th>Date</th><th>ผล</th><th>จัดการ</th>
          </tr>
        </thead>
        <tbody id="jobsBody"></tbody>
      </table>
    </div>

    <!-- Tags (print only tags) -->
    <div class="card hidden tag-sheet" id="tagArea">
      <div class="row" style="justify-content:space-between">
        <div><strong>Tag *แปะอุปกรณ์</strong> — เลือกงานในตารางแล้วกด “ออก Tag อุปกรณ์”</div>
        <div class="row"><button class="btn dark" onclick="window.print()">พิมพ์เฉพาะ Tag</button>
          <button class="btn ghost" id="btnCloseTag">ซ่อน</button></div>
      </div>
      <hr class="sep"/>
      <div class="tag-list" id="tagList"></div>
    </div>
  </div>

  <!-- 2) Setup -->
  <div class="container hidden" id="page-setup">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><strong>Calibration Setup</strong></div>
        <button class="btn" id="btnSaveSetup">บันทึก/ถัดไป</button>
      </div>
      <hr class="sep"/>

      <!-- Customer & Department & Certificate -->
      <div class="grid grid-2">
        <div class="blk">
          <div class="label">Customer Information</div>
          <label>Company</label>
          <input id="custCompany" class="input" list="companyList" placeholder="ชื่อลูกค้า/โรงงาน"/>
          <datalist id="companyList"></datalist>

          <label>Address</label>
          <textarea id="custAddr" class="input" rows="2" list="addressList" placeholder="ที่อยู่ลูกค้า"></textarea>
          <datalist id="addressList"></datalist>
        </div>

        <div class="blk">
          <div class="label">Department (เดิม: Place of calibration)</div>
          <label>Department / Company</label>
          <input id="placeDept" class="input" list="companyList" placeholder="หน่วยงาน/แผนกที่ทำการสอบเทียบ"/>
          <label>Address</label>
          <textarea id="placeAddr" class="input" rows="2" list="addressList" placeholder="ที่อยู่หน่วยงาน"></textarea>
        </div>
      </div>

      <div class="grid grid-3" style="margin-top:12px">
        <div class="blk">
          <div class="label">Certificate</div>
          <label>No.</label><input id="certNo" class="input" placeholder="เลขที่ใบรับรอง"/>
          <label>Received</label><input id="certReceived" class="input" type="date"/>
          <label>Issue Date</label><input id="certIssue" class="input" type="date"/>
        </div>

        <div class="blk">
          <div class="label">Instrument (UUC)</div>
          <label>Instrument Type *</label>
          <select id="insType" class="input">
            <option value="">เลือก</option><option>Bourdon Tube Gauge</option><option>Electric Pressure Gauge</option><option>Pressure Transmitter</option>
          </select>
          <label>Serial Number *</label><input id="serial" class="input" placeholder="PT-2025-001"/>
          <label>Model *</label><input id="model" class="input" placeholder="3051C"/>
          <label>Manufacturer</label><input id="mfg" class="input" placeholder="Rosemount"/>
        </div>

        <div class="blk">
          <div class="label">Ranges & Environment</div>
          <label>Measurement Range (min—max) *</label>
          <div class="row">
            <input id="rangeMin" class="input" type="number" placeholder="0" style="max-width:160px">
            <span>—</span>
            <input id="rangeMax" class="input" type="number" placeholder="10" style="max-width:160px">
            <select id="unit" class="input" style="max-width:130px">
              <option>bar</option><option>kPa</option><option>mmHg</option><option>psi</option><option>Pa</option>
            </select>
          </div>
          <div class="helper">ตัวอย่าง: 0—10 bar</div>

          <label>Medium *</label>
          <select id="medium" class="input"><option>Air</option><option>Nitrogen</option><option>Oil</option><option>Water</option></select>
          <label>Calibration Date *</label><input id="calDate" class="input" type="date"/>

          <!-- Env equal level -->
          <div class="env-grid" style="margin-top:8px">
            <div><label>Temp (°C) *</label><input id="envTemp" class="input" type="number" placeholder="18-28"></div>
            <div><label>Humidity (%RH)</label><input id="envHumid" class="input" type="number" placeholder="50"></div>
            <div><label>Atm (mbar) *</label><input id="envAtm" class="input" type="number" placeholder="1013"></div>
          </div>
        </div>
      </div>

      <!-- Accuracy / Points -->
      <hr class="sep"/>
      <div class="grid grid-3">
        <div>
          <label>Accuracy Class *</label>
          <select id="accClass" class="input">
            <option value="">เลือก</option><option>&lt; 0.1%</option><option>0.1% - 0.6%</option><option>&gt; 0.6%</option>
          </select>
          <div class="helper">ระบบเลือก Sequence ให้อัตโนมัติ</div>
        </div>
        <div>
          <label>Calibration Sequence (Auto)</label>
          <input id="sequence" class="input" readonly placeholder="A/B/C by Accuracy Class"/>
          <div class="helper">A: 2Up+2Down (9 pts) • B: 2Up+1Down (9 pts) • C: 1Up+1Down (5 pts)</div>
        </div>
        <div>
          <label>Calibration Points (bar) *</label>
          <div class="row">
            <button class="btn ghost" id="btnAutoPoints">สร้างจุดอัตโนมัติ</button>
            <button class="btn ghost" id="btnClearPoints">ล้าง</button>
          </div>
        </div>
      </div>
      <div id="pointsBox" class="grid grid-4" style="margin-top:10px"></div>

      <!-- Standards used -->
      <hr class="sep"/>
      <div class="blk">
        <div class="label">Standards used</div>
        <div class="row">
          <input id="stdIn_serial" class="input" placeholder="Serial No." style="max-width:160px">
          <input id="stdIn_cert" class="input" placeholder="Certificate No." style="max-width:180px">
          <input id="stdIn_calDate" class="input" type="date" style="max-width:160px">
          <input id="stdIn_dueDate" class="input" type="date" style="max-width:160px">
          <input id="stdIn_desc" class="input" placeholder="Description" style="flex:1">
          <select id="stdIn_status" class="input" style="max-width:140px"><option>OK</option><option>DUE</option><option>EXPIRED</option></select>
          <button class="btn" id="addStdRow">เพิ่ม</button>
        </div>
        <table class="table" style="margin-top:8px">
          <thead><tr><th>Serial</th><th>Certificate</th><th>Calibration date</th><th>Due date</th><th>Description</th><th>Status</th><th></th></tr></thead>
          <tbody id="stdList"></tbody>
        </table>
      </div>

      <!-- Signatures -->
      <hr class="sep"/>
      <div class="blk">
        <div class="label">Signatures / Names</div>
        <div class="sig-grid">
          <div>
            <label>Technician Name *</label><input id="sigTechName" class="input" placeholder="ผู้ปฏิบัติการสอบเทียบ">
            <label>Technician Title</label><input id="sigTechTitle" class="input" placeholder="ตำแหน่ง">
            <label>Technician Date</label><input id="sigTechDate" class="input" type="date">
          </div>
          <div>
            <label>Reviewer Name</label><input id="sigRevName" class="input" placeholder="ผู้ตรวจทาน">
            <label>Reviewer Title</label><input id="sigRevTitle" class="input" placeholder="ตำแหน่ง">
            <label>Reviewer Date</label><input id="sigRevDate" class="input" type="date">
          </div>
          <div>
            <label>Approver Name</label><input id="sigAppName" class="input" placeholder="ผู้อนุมัติ">
            <label>Approver Title</label><input id="sigAppTitle" class="input" placeholder="ตำแหน่ง">
            <label>Approver Date</label><input id="sigAppDate" class="input" type="date">
          </div>
        </div>
      </div>

      <!-- Limits -->
      <hr class="sep"/>
      <div class="blk">
        <div class="label">Acceptance / Plant Limit</div>
        <div class="grid grid-3">
          <div><label>MPE / Acceptance (bar)</label><input id="accLimitBar" class="input" type="number" placeholder="เว้นว่าง=0.1%FS"></div>
          <div><label>Factory Limit (bar)</label><input id="plantLimitBar" class="input" type="number" placeholder="ลิมิตเฉพาะโรงงาน (ถ้ามี)"></div>
          <div><label>แนะนำค่าแก้</label><select id="enableCorrection" class="input"><option>Yes</option><option>No</option></select></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 3) Entry -->
  <div class="container hidden" id="page-entry">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><strong>Measurement Data Entry — STD/UUC (คำนวณอัตโนมัติ)</strong></div>
        <div class="row"><button class="btn ghost" id="btnSaveEntry">บันทึก</button></div>
      </div>
      <hr class="sep"/>
      <div class="grid grid-3">
        <div><label>Standard Name</label><input id="stdName" class="input" placeholder="Deadweight Tester"/></div>
        <div><label>Standard Serial</label><input id="stdSerial" class="input" placeholder="DWT-001"/></div>
        <div><label>Standard Accuracy (% หรือ ค่าสัมบูรณ์)</label><input id="stdAcc" class="input" type="number" placeholder="0.02"/></div>
        <div><label>Standard Resolution (bar)</label><input id="stdRes" class="input" type="number" placeholder="0.001"/></div>
        <div><label>Standard Certificate No.</label><input id="stdCert" class="input" placeholder="CAL-2025-001"/></div>
      </div>
      <hr class="sep"/>
      <div id="entryTableWrap" class="card"></div>
      <div class="small">อัปเดตค่าใดๆ ระบบจะคำนวณใหม่ทันที (Avg, Deviation, Hysteresis)</div>
    </div>
  </div>

  <!-- 4) Uncertainty -->
  <div class="container hidden" id="page-uncert">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><strong>Uncertainty Calculation</strong></div>
        <div class="row">
          <button class="btn dark" id="btnAutoFromData">Auto-fill จากข้อมูล</button>
          <button class="btn ghost" id="btnSaveUncert">บันทึก</button>
        </div>
      </div>
      <hr class="sep"/>

      <div class="grid grid-3">
        <div><label>u_standard</label><input id="u_standard" class="input" type="number" placeholder="Accuracy_STD/√3"><div class="small">ตัวอย่าง: STD 0.02 bar → u_standard ≈ 0.02/√3</div></div>
        <div><label>u_resolution_std</label><input id="u_res_std" class="input" type="number" placeholder="Resolution_STD/(2√3)"><div class="small">ตัวอย่าง: res 0.001 bar → 0.001/(2√3)</div></div>
        <div><label>u_zero</label><input id="u_zero" class="input" type="number" placeholder="max(Zero Deviation)/√3"><div class="small">อิง dev ที่จุด 0 bar</div></div>
        <div><label>u_repeatability</label><input id="u_repeat" class="input" type="number" placeholder="SD/√n"><div class="small">SD ของ deviation ทุกจุด / √n</div></div>
        <div><label>u_hysteresis</label><input id="u_hyst" class="input" type="number" placeholder="Mean(Hysteresis)/√3"><div class="small">ค่าเฉลี่ยฮิสเทอรีซีส</div></div>
        <div class="blk">U (k=2) = 2 × √( u_std² + u_res² + u_zero² + u_repeat² + u_hyst² )<div class="small">ระบบจะคำนวณผลรวมและสรุป Pass/Fail อัตโนมัติ</div></div>
      </div>

      <hr class="sep"/>
      <div id="uncertSummary" class="small"></div>
    </div>
  </div>

  <!-- 5) Report -->
  <div class="container hidden" id="page-report">
    <div class="card" id="reportCard">
      <div class="report-head">
        <div class="blk">
          <div class="label">Instrument Calibration Office of Technical For Spirit Production</div>
          <div class="small">260 Sangsom Building, Phaholyothin Road, Samsen-ai, Phayathai, Bangkok 10400 • Tel. 02-278-4321 # 5115</div>
          <hr class="sep"/>
          <div class="report-grid report-2">
            <div><b>Customer</b><br>Company: <span id="rCustomer">—</span><br>Address: <span id="rCustAddr">—</span></div>
            <div><b>Department</b><br>Company: <span id="rPlaceCompany">—</span><br>Address: <span id="rPlaceAddr">—</span></div>
          </div>
        </div>
        <div class="blk">
          <div class="label">Certificate</div>
          <div>No.: <span id="rCertNo">—</span></div>
          <div>Received: <span id="rReceived">—</span></div>
          <div>Calibration: <span id="rCalDate">—</span></div>
          <div>Issue Date: <span id="rIssueDate">—</span></div>
        </div>
      </div>

      <hr class="sep"/>

      <div class="report-grid report-3">
        <div class="blk">
          <div class="label">Instrument (UUC)</div>
          <div>Type: <span id="rType">—</span></div>
          <div>Model/Code: <span id="rModel">—</span></div>
          <div>Serial No.: <span id="rSerial">—</span></div>
          <div>Manufacturer: <span id="rMfg">—</span></div>
        </div>
        <div class="blk">
          <div class="label">Ranges & Specs</div>
          <div>Measuring range: <span id="rMeasureRange">—</span></div>
          <div>Calibration range: <span id="rCalRange">—</span></div>
          <div>Resolution: <span id="rResolution">—</span></div>
          <div>MPE/Acceptance: <span id="rMPE">—</span></div>
          <div>Factory Limit: <span id="rPlantLimit">—</span></div>
        </div>
        <div class="blk">
          <div class="label">Result Status</div>
          <div>Result of Calibration: <span id="rVerdict"><span class="badge">—</span></span></div>
          <div>U (k=2): <span id="rU">—</span></div>
        </div>
      </div>

      <hr class="sep"/>

      <div class="blk">
        <div class="label">Standards used</div>
        <table class="table" id="stdTable">
          <thead><tr><th>Serial No.</th><th>Certificate No.</th><th>Calibration date</th><th>Due date</th><th>Description</th><th>Status</th></tr></thead>
        <tbody id="stdBody"></tbody></table>
      </div>

      <hr class="sep"/>

      <div class="blk">
        <div class="label">Environment Conditions</div>
        <div>T: <span id="rAmbT">—</span> °C, RH: <span id="rAmbH">—</span> %RH, Atm: <span id="rAmbP">—</span> mbar</div>
      </div>

      <hr class="sep"/>

      <div class="blk">
        <div class="label">Measurement Result (key columns)</div>
        <div id="resultTableWrap"></div>
        <div class="small">หัวตาราง: Standard Reading [bar] (1) • UUC* Reading [mA] • Calculation Pressure [bar] (2) • Measurement Deviation [bar] (2)-(1) • Uncertainty [bar] • Result [Pass/Fail]</div>
      </div>

      <hr class="sep"/>

      <div class="blk">
        <div class="label">Analysis (AI-like)</div>
        <div id="aiNote" class="small"></div>
      </div>

      <hr class="sep"/>
      <div class="blk">
        <div class="label">Signatures</div>
        <div class="sig-grid">
          <div><div class="sig-box"><div id="sigTechNameOut">—</div><div class="small" id="sigTechTitleOut">—</div><div class="small" id="sigTechDateOut">—</div></div><div class="small" style="text-align:center;margin-top:4px">Technician</div></div>
          <div><div class="sig-box"><div id="sigRevNameOut">—</div><div class="small" id="sigRevTitleOut">—</div><div class="small" id="sigRevDateOut">—</div></div><div class="small" style="text-align:center;margin-top:4px">Reviewer</div></div>
          <div><div class="sig-box"><div id="sigAppNameOut">—</div><div class="small" id="sigAppTitleOut">—</div><div class="small" id="sigAppDateOut">—</div></div><div class="small" style="text-align:center;margin-top:4px">Approver</div></div>
        </div>
      </div>

      <hr class="sep"/>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="btnMakePDF">Export PDF</button>
        <button class="btn ghost" id="btnCSV">Export CSV</button>
      </div>
    </div>
  </div>

  <!-- 6) Charts -->
  <div class="container hidden" id="page-charts">
    <div class="card">
      <div class="row" style="justify-content:space-between"><div><strong>Charts</strong> — Accuracy/Errors/Uncertainty</div></div>
      <hr class="sep"/>
      <div class="grid grid-2">
        <div class="blk"><canvas id="chartAccuracy"></canvas></div>
        <div class="blk"><canvas id="chartError"></canvas></div>
      </div>
      <div class="grid grid-2" style="margin-top:12px">
        <div class="blk"><canvas id="chartErrPlusU"></canvas></div>
        <div class="blk"><canvas id="chartErrMinusU"></canvas></div>
      </div>
      <hr class="sep"/>
      <div class="blk">
        <div class="label">AI Chart Insights</div>
        <div id="aiCharts" class="small"></div>
      </div>
    </div>
  </div>

  <!-- 7) Guide -->
  <div class="container hidden" id="page-help">
    <div class="card">
      <h3>Formula & Guide (ละเอียด)</h3>
      <div class="grid grid-2">
        <div class="blk">
          <div class="label">สูตรหลักสำหรับการสอบเทียบ</div>
          <ol>
            <li><b>แก้ความดันตามระดับความสูง</b>: ΔP = (ρ<sub>f</sub> − ρ<sub>a</sub>)·g·Δh</li>
            <li><b>Zero correction</b>:
              N₁,ⱼ = U₁,ⱼ; N₂,ⱼ = (S₁,ⱼ − S₂,ⱼ)+U₂,ⱼ;
              M₁,ⱼ = N₁,ⱼ − N₁,₀; M₂,ⱼ = N₂,ⱼ − N₁,₀
            </li>
            <li><b>แปลงสัญญาณเป็นความดัน</b> (4–20mA): P = P<sub>min</sub> + (I−4)/(20−4)·(P<sub>FS</sub>)</li>
            <li><b>ความไม่แน่นอนรวม</b>: U = 2·√Σuᵢ² (k=2)</li>
          </ol>
        </div>
        <div class="blk">
          <div class="label">องค์ประกอบความไม่แน่นอน (ตัวอย่าง)</div>
          <ul>
            <li>u<sub>std</sub> = Accuracy/√3</li>
            <li>u<sub>res,std</sub> = Resolution/(2√3)</li>
            <li>u<sub>ρ,h</sub>, u<sub>g,h</sub>, u<sub>h</sub> — ผลของความหนาแน่น, g, และความสูง</li>
            <li>u<sub>DMM</sub>, u<sub>res,uuc</sub>, u<sub>zero</sub>, u<sub>hys</sub>, u<sub>repeat</sub></li>
          </ul>
        </div>
      </div>
      <hr class="sep"/>
      <div class="blk">
        <div class="label">ขั้นตอนใช้งาน</div>
        <ol>
          <li>Setup: กรอกช่วงวัด + เลือก Accuracy → ระบบสร้างจุดสอบเทียบอัตโนมัติ</li>
          <li>Entry: ใส่ STD/UUC ตาม Cycle → ตารางคำนวณ Avg/Deviation/Hysteresis อัตโนมัติ</li>
          <li>Uncertainty: กด Auto-fill หรือใส่ค่า uᵢ → ระบบคำนวณ U และ Pass/Fail</li>
          <li>Report/Charts: ตรวจตารางสรุป, กราฟ 4 แบบ, และข้อเสนออัตโนมัติ (AI-like)</li>
        </ol>
      </div>
    </div>
  </div>

  <footer class="container small">© 2025 Pressure Calibration — DKD-R 6-1</footer>

<script>
/* ===== Utilities & State ===== */
const pages=["dashboard","setup","entry","uncert","report","charts","help"];
const toBar={"bar":v=>v,"kPa":v=>v/100,"Pa":v=>v/100000,"psi":v=>v*0.0689476,"mmHg":v=>v*0.00133322};
function $(id){return document.getElementById(id)}
function val(id){return $(id).value}
function num(id){const v=parseFloat(val(id));return isNaN(v)?null:v;}
function fmt(v){return (v==null||isNaN(v))?"-":(+v).toFixed(6)}

let currentJob={
  id:null,factory:"",status:"In Progress",
  instrument:{type:"",serial:"",model:"",mfg:"",rangeMin:null,rangeMax:null,unit:"bar",medium:"",calDate:""},
  environment:{temp:null,humid:null,atm:null},
  accuracy:{cls:"",seq:"",points:[]},
  standard:{name:"",serial:"",acc:null,res:null,cert:""},
  standards_used:[],
  table:[],results:[],
  uncertainty:{ustd:0,ures:0,uzero:0,urep:0,uhyst:0,U:0},
  verdictOverall:"",
  customer:{company:"—",address:"—"},
  place:{company:"—",address:"—"}, // Department
  cert:{no:"—",received:"—",issue:"—"},
  signature:{tech:{name:"—",title:"—",date:"—"},rev:{name:"—",title:"—",date:"—"},app:{name:"—",title:"—",date:"—"}},
  limits:{acceptance:null,plant:null,enableCorrection:true}
};

/* ===== Master: Company/Address (datalist) ===== */
const MASTER_COMPANY = [
  { c:"Athimart Co.,Ltd.", a:"170 Moo.11, Tambon Nikhom, Amphoe Satuek" },
  { c:"Sura Bangyikhan Co.,Ltd.", a:"82 Moo.3, Tsmbon Bang Khoo Wat, Amphoe Muang" },
  { c:"Fuengfuanant Co.,Ltd.", a:"333 Moo.1, Tambon Tha Toom, Amphoe Si Maha Phot" },
  { c:"Fermentation Central Officer", a:"260 Sangsom Building, Phaholyothin Road, Samsen-Nai Phayathai" },
  { c:"Luckchai Liquor Trading Co.,Ltd.", a:"46 Moo.1, Tambon Nong Klang Na, Amphoe Muang" },
  { c:"Kanchanasingkorn Co.,Ltd.", a:"50 Moo.7, Tambon Wangkhanai, Amphoe Thamuang" },
  { c:"Kankwan Co.,Ltd.", a:"309 Moo.6, Nampong-Kranuan Road, Tambon Nampong, Amphoe Nampong" },
  { c:"Red Bull Distillery(1988) Co.,Ltd.", a:"8 Moo.5, Setthakit 1 Road, Tambon Nadee, Amphoe Muang" },
  { c:"Instrument Calibration Laboratory", a:"260 Sangsom Building, Phaholyothin Road, Samsen-Nai Phayathai" },
  { c:"Mongkolsamai Co.,Ltd.", a:"149 Moo.5, Wangseesoob Ngew-Ngam Road, Tambon Phajud, Amphoe Muang" },
  { c:"Nateechai Co.,Ltd.", a:"1 Moo.2, Highway No.41 Road, Tambon Tharongchang, Amphoe Punpin" },
  { c:"United Products Co.,Ltd.", a:"56 Moo.2, Sukhaphiban Road, Tambon Nakhonchaisri, Amphoe Nakhonchaisri" },
  { c:"Sura Piset Pattharalanna Co.,Ltd.", a:"14 Sangsom Building, Soi Yasoob 1, Vibhavadi Rangsit Road, Chomphon, Chatuchak" },
  { c:"Sangsom Co.,Ltd. (Hormkret)", a:"49 Moo.4, Tambon Hormkret, Amphoe Sampran" },
  { c:"Sangsom Co.,Ltd. (Wangkhanai)", a:"37/3 Moo.7, Tambon Wangkhanai, Amphoe Thamuang" },
  { c:"S.S. Karnsura Co.,Ltd.", a:"101 Moo.8, Tambon Kaeng Dom, King Amphoe Sawang Wirawong" },
  { c:"Simathurakij Co.,Ltd.", a:"1 Moo.6, Tambon Ban Daen, Amphoe Banphot Phisai" },
  { c:"SPM Foods and Beverages Co.,Ltd.", a:"79 Moo.3, Tambon Lumlookbua, Amphoe Dontoom" },
  { c:"Thanapakdi Co.,Ltd.", a:"315 Moo.4, Tambon Mae Faek, Amphoe San Sai" },
  { c:"Sura Piset Thipharat Co.,Ltd.", a:"488 Moo.1, Tambon Wangdong, Amphoe Muang" },
  { c:"Theparunothai Co.,Ltd.", a:"99 Moo.4, Tambon Hat Kham, Amphoe Muang" },
  { c:"United Winery and Distillery Co.,Ltd.", a:"54 Moo.2, Sukhaphiban Road, Tambon Nakhonchaisri, Amphoe Nakhonchaisri" },
];
function populateCompanyMaster(){
  const cList = $("companyList"); const aList = $("addressList");
  cList.innerHTML=""; aList.innerHTML="";
  MASTER_COMPANY.forEach(x=>{
    const o1=document.createElement("option"); o1.value=x.c; cList.appendChild(o1);
    const o2=document.createElement("option"); o2.value=x.a; aList.appendChild(o2);
  });
  $("custCompany").addEventListener("change", ()=>{
    const f = MASTER_COMPANY.find(x=>x.c===val("custCompany"));
    if(f){ $("custAddr").value = f.a; }
  });
  $("placeDept").addEventListener("change", ()=>{
    const f = MASTER_COMPANY.find(x=>x.c===val("placeDept"));
    if(f){ $("placeAddr").value = f.a; }
  });
}

/* ===== Local storage ===== */
async function saveJob(job){
  const l=JSON.parse(localStorage.getItem("cal_jobs")||"[]");
  if(!job.id){job.id="local_"+Date.now(); l.push(job);}
  else {const i=l.findIndex(x=>x.id===job.id); if(i>=0) l[i]=job; else l.push(job);}
  localStorage.setItem("cal_jobs",JSON.stringify(l));
  return job.id;
}
async function loadJobs(){return JSON.parse(localStorage.getItem("cal_jobs")||"[]")}
async function deleteJob(id){const l=(await loadJobs()).filter(x=>x.id!==id); localStorage.setItem("cal_jobs",JSON.stringify(l)); refreshDashboard();}

/* ===== Navigation ===== */
$("nav").addEventListener("click",e=>{ if(e.target.classList.contains("tab")) switchPage(e.target.dataset.page); });
function switchPage(p){
  document.querySelectorAll(".tab").forEach(b=>b.classList.toggle("active",b.dataset.page===p));
  pages.forEach(id=>$("page-"+id).classList.toggle("hidden",id!==p));
  location.hash=p;
  if(p==="entry"){ autoBuildEntry(); }
  if(p==="report"){ buildReportHeader(); ensureResults(); buildResultTable(); makeAutoAnalysis(); }
  if(p==="charts"){ ensureResults(); buildCharts(); makeAICharts(); }
}
if(location.hash){const h=location.hash.slice(1); if(pages.includes(h)) switchPage(h);}

/* ===== Dashboard ===== */
async function refreshDashboard(){
  const jobs=await loadJobs(), txt=(val("searchText")||"").toLowerCase(), df=val("filterDateFrom"), dt=val("filterDateTo"), st=val("filterStatus");
  const filtered=jobs.filter(j=>{
    const s1=!txt || (j.instrument?.model||"").toLowerCase().includes(txt) || (j.instrument?.serial||"").toLowerCase().includes(txt);
    const d=j.instrument?.calDate||""; const s2=(!df||d>=df)&&(!dt||d<=dt); const s3=!st || j.status===st || j.verdictOverall===st; return s1&&s2&&s3;
  });
  $("kpi-total").innerText=jobs.length;
  $("kpi-progress").innerText=jobs.filter(x=>x.status==="In Progress").length;
  $("kpi-completed").innerText=jobs.filter(x=>x.status==="Completed").length;
  $("kpi-pass").innerText=jobs.filter(x=>x.verdictOverall==="Pass").length;
  $("kpi-fail").innerText=jobs.filter(x=>x.verdictOverall==="Fail").length;

  const tb=$("jobsBody"); tb.innerHTML="";
  filtered.forEach(j=>{
    const tr=document.createElement("tr");
    const badge=j.verdictOverall?`<span class="badge ${j.verdictOverall==='Pass'?'pass':'fail'}">${j.verdictOverall}</span>`:"-";
    tr.innerHTML=`
      <td><input type="checkbox" class="chkRow" data-id="${j.id}"></td>
      <td>${j.customer?.company||j.factory||"-"}</td>
      <td>${j.instrument?.type||"-"}</td>
      <td>${j.instrument?.serial||"-"}</td>
      <td>${j.instrument?.rangeMin}–${j.instrument?.rangeMax} ${j.instrument?.unit}</td>
      <td>${j.status||"-"}</td>
      <td>${j.instrument?.calDate||"-"}</td>
      <td>${badge}</td>
      <td class="row">
        <button class="btn" onclick='loadIntoEditor(${JSON.stringify(j).replace(/'/g,"&#39;")})'>ดู/แก้ไข</button>
        <button class="btn warn" onclick="cloneJob('${j.id}')">คัดลอก</button>
        <button class="btn fail" onclick="if(confirm('ลบงานนี้?')) deleteJob('${j.id}')">ลบ</button>
      </td>`;
    tb.appendChild(tr);
  });
}
$("btnSearch").addEventListener("click",refreshDashboard);
$("btnNew").addEventListener("click",()=>{
  currentJob={...currentJob,id:null,status:"In Progress"};
  currentJob.customer={company:val("factorySelect")||"—",address:"—"};
  fillSetupForm(); switchPage("setup");
});
$("chkAll").addEventListener("change",e=>{ document.querySelectorAll(".chkRow").forEach(c=>c.checked=e.target.checked); });
function loadIntoEditor(j){ currentJob=JSON.parse(JSON.stringify(j)); fillSetupForm(); switchPage("setup"); }
function cloneJob(id){ loadJobs().then(l=>{const j=l.find(x=>x.id===id); if(!j) return; const c=JSON.parse(JSON.stringify(j)); c.id=null; c.status="In Progress"; c.verdictOverall=""; currentJob=c; fillSetupForm(); switchPage("setup");}); }

/* ---- Tag printing ---- */
$("btnPrintTag").addEventListener("click",async()=>{
  const jobs=await loadJobs();
  const ids=[...document.querySelectorAll(".chkRow:checked")].map(x=>x.dataset.id);
  const sel=jobs.filter(j=>ids.includes(j.id));
  if(sel.length===0){ alert("กรุณาเลือกงานในตารางก่อน"); return; }
  const tagList=$("tagList"); tagList.innerHTML="";
  sel.forEach((j,i)=>{
    const qp="qr_"+i, U=j.uncertainty?.U??0;
    const dev0=(j.table||[]).find(r=>r.point===0)?.dev ?? (j.results||[]).find(r=>r.point===0)?.deviation ?? 0;
    const errSpan0=Math.abs(dev0)+(U||0);
    const div=document.createElement("div"); div.className="tag";
    div.innerHTML=`
      <div class="h">${j.instrument?.type||"-"}</div>
      <div class="l">Model: ${j.instrument?.model||"-"} | S/N: ${j.instrument?.serial||"-"}</div>
      <div class="l">Range: ${j.instrument?.rangeMin}–${j.instrument?.rangeMax} ${j.instrument?.unit}</div>
      <div class="l">Date: ${j.instrument?.calDate||"-"} | Verdict: ${j.verdictOverall?`<span class="badge ${j.verdictOverall==='Pass'?'pass':'fail'}">${j.verdictOverall}</span>`:"-"}</div>
      <div class="l"><b>Error@0</b>: Dev=${fmt(dev0)} | U=${fmt(U)} | Span=${fmt(errSpan0)}</div>
      <div id="${qp}" style="width:80px;height:80px;margin-top:6px"></div>`;
    tagList.appendChild(div);
    new QRCode($(qp),{text:j.id||"local",width:80,height:80});
  });
  $("tagArea").classList.remove("hidden");
  $("tagArea").scrollIntoView({behavior:"smooth"});
});
$("btnCloseTag").addEventListener("click",()=>$("tagArea").classList.add("hidden"));

/* ===== Setup ===== */
function fillSetupForm(){
  const i=currentJob.instrument, e=currentJob.environment, a=currentJob.accuracy, s=currentJob.signature;
  $("custCompany").value=currentJob.customer.company||"";
  $("custAddr").value=currentJob.customer.address||"";
  $("placeDept").value=currentJob.place.company||"";  // Department
  $("placeAddr").value=currentJob.place.address||"";
  $("certNo").value=currentJob.cert.no||"";
  $("certReceived").value=currentJob.cert.received||"";
  $("certIssue").value=currentJob.cert.issue||"";
  $("insType").value=i.type||""; $("serial").value=i.serial||""; $("model").value=i.model||"";
  $("mfg").value=i.mfg||""; $("rangeMin").value=i.rangeMin??""; $("rangeMax").value=i.rangeMax??"";
  $("unit").value=i.unit||"bar"; $("medium").value=i.medium||""; $("calDate").value=i.calDate||"";
  $("envTemp").value=e.temp??""; $("envHumid").value=e.humid??""; $("envAtm").value=e.atm??"";
  $("accClass").value=a.cls||""; $("sequence").value=a.seq||"";
  $("sigTechName").value=s.tech.name||""; $("sigTechTitle").value=s.tech.title||""; $("sigTechDate").value=s.tech.date||"";
  $("sigRevName").value=s.rev.name||""; $("sigRevTitle").value=s.rev.title||""; $("sigRevDate").value=s.rev.date||"";
  $("sigAppName").value=s.app.name||""; $("sigAppTitle").value=s.app.title||""; $("sigAppDate").value=s.app.date||"";
  $("accLimitBar").value=currentJob.limits.acceptance??""; $("plantLimitBar").value=currentJob.limits.plant??"";
  $("enableCorrection").value=currentJob.limits.enableCorrection?"Yes":"No";
  renderPoints(); renderStdList();
}
$("accClass").addEventListener("change",()=>{
  const v=val("accClass"); let seq="";
  if(v==="< 0.1%") seq="A (2Up+2Down, 9 pts)";
  else if(v==="0.1% - 0.6%") seq="B (2Up+1Down, 9 pts)";
  else if(v==="> 0.6%") seq="C (1Up+1Down, 5 pts)";
  currentJob.accuracy.cls=v; currentJob.accuracy.seq=seq; $("sequence").value=seq;
});
$("btnAutoPoints").addEventListener("click",()=>{
  const min=parseFloat(val("rangeMin")), max=parseFloat(val("rangeMax")), unit=val("unit");
  if(isNaN(min)||isNaN(max)||max<=min){alert("ช่วงวัดไม่ถูกต้อง");return;}
  const seq=currentJob.accuracy.seq||"", perc=(seq.startsWith("A")||seq.startsWith("B"))?[0,12.5,25,37.5,50,62.5,75,87.5,100]:[0,25,50,75,100];
  const minBar=(toBar[unit]||((x)=>x))(min), maxBar=(toBar[unit]||((x)=>x))(max);
  currentJob.accuracy.points=perc.map(p=>+(minBar+(maxBar-minBar)*(p/100)).toFixed(5));
  renderPoints();
});
$("btnClearPoints").addEventListener("click",()=>{currentJob.accuracy.points=[];renderPoints();});
function renderPoints(){
  const box=$("pointsBox"); box.innerHTML="";
  currentJob.accuracy.points.forEach((v,i)=>{
    const d=document.createElement("div");
    d.innerHTML=`<label>Point ${i+1} (bar)</label>
    <div class="row"><input class="input" type="number" step="0.00001" value="${v}" oninput="updatePoint(${i},this.value)">
    <button class="btn warn" onclick="removePoint(${i})">ลบ</button></div>`;
    box.appendChild(d);
  });
  const add=document.createElement("div");
  add.innerHTML=`<label>เพิ่มจุด (bar)</label>
    <div class="row"><input class="input" id="newPointVal" type="number" step="0.00001" placeholder="1.25">
    <button class="btn ghost" onclick="addPoint()">เพิ่ม</button></div>`;
  box.appendChild(add);
}
window.updatePoint=(i,v)=>currentJob.accuracy.points[i]=parseFloat(v)||0;
window.removePoint=(i)=>{currentJob.accuracy.points.splice(i,1); renderPoints();};
window.addPoint=()=>{const v=parseFloat(val("newPointVal")); if(isNaN(v))return; currentJob.accuracy.points.push(v); renderPoints();};

/* Standards used editor */
$("addStdRow").addEventListener("click",()=>{
  const row={serial:val("stdIn_serial")||"—",cert:val("stdIn_cert")||"—",calDate:val("stdIn_calDate")||"—",
             dueDate:val("stdIn_dueDate")||"—",desc:val("stdIn_desc")||"—",status:val("stdIn_status")||"OK"};
  currentJob.standards_used.push(row); renderStdList();
  ["stdIn_serial","stdIn_cert","stdIn_calDate","stdIn_dueDate","stdIn_desc"].forEach(id=>$(id).value="");
});
function renderStdList(){
  const tb=$("stdList"); tb.innerHTML="";
  (currentJob.standards_used||[]).forEach((s,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${s.serial}</td><td>${s.cert}</td><td>${s.calDate}</td><td>${s.dueDate}</td><td>${s.desc}</td><td>${s.status}</td>
    <td><button class="btn fail" onclick="delStd(${idx})">ลบ</button></td>`;
    tb.appendChild(tr);
  });
}
window.delStd=(idx)=>{currentJob.standards_used.splice(idx,1); renderStdList();};

/* Save Setup */
$("btnSaveSetup").addEventListener("click",async()=>{
  currentJob.customer.company=val("custCompany")||"—";
  currentJob.customer.address=val("custAddr")||"—";

  // Department (แทน placeCompany)
  currentJob.place.company=val("placeDept")||"—";
  currentJob.place.address=val("placeAddr")||"—";

  currentJob.cert.no=val("certNo")||"—"; currentJob.cert.received=val("certReceived")||"—"; currentJob.cert.issue=val("certIssue")||"—";
  const i=currentJob.instrument;
  i.type=val("insType"); i.serial=val("serial"); i.model=val("model"); i.mfg=val("mfg");
  i.rangeMin=num("rangeMin"); i.rangeMax=num("rangeMax"); i.unit=val("unit"); i.medium=val("medium"); i.calDate=val("calDate");
  const e=currentJob.environment; e.temp=num("envTemp"); e.humid=num("envHumid"); e.atm=num("envAtm");
  const s=currentJob.signature;
  s.tech.name=val("sigTechName")||"—"; s.tech.title=val("sigTechTitle")||"—"; s.tech.date=val("sigTechDate")||"—";
  s.rev.name=val("sigRevName")||"—"; s.rev.title=val("sigRevTitle")||"—"; s.rev.date=val("sigRevDate")||"—";
  s.app.name=val("sigAppName")||"—"; s.app.title=val("sigAppTitle")||"—"; s.app.date=val("sigAppDate")||"—";
  currentJob.limits.acceptance=num("accLimitBar"); currentJob.limits.plant=num("plantLimitBar"); currentJob.limits.enableCorrection=(val("enableCorrection")==="Yes");

  if(!i.type||!i.serial||!i.model||isNaN(i.rangeMin)||isNaN(i.rangeMax)||!i.calDate||currentJob.accuracy.points.length===0){alert("กรอกช่องบังคับ + จุดสอบเทียบ");return;}
  await saveJob(currentJob); await refreshDashboard(); switchPage("entry");
});

/* ===== Entry ===== */
function getCycles(){const s=currentJob.accuracy.seq||""; if(s.startsWith("A"))return{up:2,down:2}; if(s.startsWith("B"))return{up:2,down:1}; return{up:1,down:1};}
function autoBuildEntry(){
  $("stdName").value=currentJob.standard.name||"";
  $("stdSerial").value=currentJob.standard.serial||"";
  $("stdAcc").value=currentJob.standard.acc??"";
  $("stdRes").value=currentJob.standard.res??"";
  $("stdCert").value=currentJob.standard.cert||"";
  const pts=currentJob.accuracy.points||[]; const cyc=getCycles();
  if(!currentJob.table || currentJob.table.length!==pts.length){
    currentJob.table=pts.map(p=>({point:p,up:Array(cyc.up).fill(null).map(()=>({STD:"",UUC:""})),down:Array(cyc.down).fill(null).map(()=>({STD:"",UUC:""})),avgSTD:null,avgUUC:null,dev:null,hyst:null}));
  }
  renderEntryTable(); calcTable();
}
function renderEntryTable(){
  const wrap=$("entryTableWrap"); const cyc=getCycles();
  let h=`<table class="table"><thead><tr><th>Point (bar)</th>`;
  for(let i=1;i<=cyc.up;i++){h+=`<th>STD (Up${i})</th><th>UUC (Up${i})</th>`}
  for(let i=1;i<=cyc.down;i++){h+=`<th>STD (Down${i})</th><th>UUC (Down${i})</th>`}
  h+=`<th>Avg STD</th><th>Avg UUC</th><th>Deviation</th><th>Hysteresis</th></tr></thead><tbody>`;
  currentJob.table.forEach((r,ri)=>{
    h+=`<tr><td>${r.point}</td>`;
    for(let i=0;i<cyc.up;i++){h+=cell(ri,'up',i,'STD')+cell(ri,'up',i,'UUC')}
    for(let i=0;i<cyc.down;i++){h+=cell(ri,'down',i,'STD')+cell(ri,'down',i,'UUC')}
    h+=`<td>${r.avgSTD??"-"}</td><td>${r.avgUUC??"-"}</td><td>${r.dev??"-"}</td><td>${r.hyst??"-"}</td></tr>`;
  });
  h+=`</tbody></table>`; wrap.innerHTML=h;
}
function cell(ri,dir,idx,key){
  const v=currentJob.table[ri][dir][idx][key]||"";
  return `<td><input class="input mcell" data-ri="${ri}" data-dir="${dir}" data-idx="${idx}" data-key="${key}" type="number" step="0.00001" value="${v}"></td>`;
}
// เก็บค่าขณะพิมพ์ แล้วคำนวณตอน blur/change
function handleEntryEdit(e){
  if(!e.target.classList.contains("mcell"))return;
  const ri=+e.target.dataset.ri, dir=e.target.dataset.dir, idx=+e.target.dataset.idx, key=e.target.dataset.key;
  const v=e.target.value;
  currentJob.table[ri][dir][idx][key]=(v===""? "": (isNaN(parseFloat(v))? "": parseFloat(v)));
}
$("entryTableWrap").addEventListener("change",handleEntryEdit);
$("entryTableWrap").addEventListener("blur",function(e){ handleEntryEdit(e); calcTable(); },true);

function calcTable(){
  const cyc=getCycles();
  currentJob.table.forEach(r=>{
    const upsSTD=r.up.map(x=>parseFloat(x.STD)).filter(n=>!isNaN(n));
    const upsUUC=r.up.map(x=>parseFloat(x.UUC)).filter(n=>!isNaN(n));
    const dnsSTD=r.down.map(x=>parseFloat(x.STD)).filter(n=>!isNaN(n));
    const dnsUUC=r.down.map(x=>parseFloat(x.UUC)).filter(n=>!isNaN(n));
    let avgSTD=null, avgUUC=null;
    if(cyc.up===2&&cyc.down===1){
      if(upsSTD.length===2&&dnsSTD.length===1) avgSTD=((upsSTD[0]+upsSTD[1])/2 + dnsSTD[0])/2;
      if(upsUUC.length===2&&dnsUUC.length===1) avgUUC=((upsUUC[0]+upsUUC[1])/2 + dnsUUC[0])/2;
    }else{
      const allSTD=upsSTD.concat(dnsSTD), allUUC=upsUUC.concat(dnsUUC);
      if(allSTD.length>0) avgSTD=allSTD.reduce((a,b)=>a+b,0)/allSTD.length;
      if(allUUC.length>0) avgUUC=allUUC.reduce((a,b)=>a+b,0)/allUUC.length;
    }
    const dev=(avgUUC!=null&&avgSTD!=null)? +(avgUUC-avgSTD).toFixed(6):null;
    let hyst=null; if(upsUUC.length>0&&dnsUUC.length>0){
      const upAvg=upsUUC.reduce((a,b)=>a+b,0)/upsUUC.length; const dnAvg=dnsUUC.reduce((a,b)=>a+b,0)/dnsUUC.length; hyst=+(upAvg-dnAvg).toFixed(6);
    }
    r.avgSTD=avgSTD!=null? +avgSTD.toFixed(6):null; r.avgUUC=avgUUC!=null? +avgUUC.toFixed(6):null; r.dev=dev; r.hyst=hyst;
  });
  renderEntryTable();
}
$("btnSaveEntry").addEventListener("click",async()=>{
  currentJob.standard.name=val("stdName");
  currentJob.standard.serial=val("stdSerial");
  currentJob.standard.acc=num("stdAcc");
  currentJob.standard.res=num("stdRes");
  currentJob.standard.cert=val("stdCert");
  await saveJob(currentJob); refreshDashboard(); switchPage("uncert");
});

/* ===== Uncertainty & Verdict ===== */
$("btnAutoFromData").addEventListener("click",()=>{
  const zeros=currentJob.table.filter(r=>r.point===0 && r.dev!=null).map(r=>Math.abs(r.dev)), maxZero=zeros.length?Math.max(...zeros):0;
  const acc=parseFloat(currentJob.standard.acc)||0; const res=parseFloat(currentJob.standard.res)||0;
  const devs=currentJob.table.map(r=>r.dev).filter(v=>v!=null); const n=devs.length;
  let sd=0; if(n>1){const mean=devs.reduce((a,b)=>a+b,0)/n; const v=devs.reduce((a,b)=>a+(b-mean)**2,0)/(n-1); sd=Math.sqrt(v);}
  const hs=currentJob.table.map(r=>r.hyst).filter(v=>v!=null); const mH=hs.length? hs.reduce((a,b)=>a+b,0)/hs.length:0;
  $("u_standard").value=(acc/Math.sqrt(3)).toFixed(6);
  $("u_res_std").value=((res)/(2*Math.sqrt(3))).toFixed(6);
  $("u_zero").value=(maxZero/Math.sqrt(3)).toFixed(6);
  $("u_repeat").value=((sd)/Math.sqrt(Math.max(1,n))).toFixed(6);
  $("u_hyst").value=(mH/Math.sqrt(3)).toFixed(6);
  calcUncertAndVerdict();
});
$("btnSaveUncert").addEventListener("click",async()=>{calcUncertAndVerdict(); await saveJob(currentJob); refreshDashboard(); switchPage("report");});
function getAcceptanceLimit(){
  const user=currentJob.limits.acceptance;
  if(user!=null && !isNaN(user)) return +(+user).toFixed(6);
  const i=currentJob.instrument, unit=i.unit||"bar";
  const spanBar=(toBar[unit]?toBar[unit](i.rangeMax):i.rangeMax)-(toBar[unit]?toBar[unit](i.rangeMin):i.rangeMin);
  return +(0.001*spanBar).toFixed(6); // default 0.1% FS
}
function calcUncertAndVerdict(){
  const u=currentJob.uncertainty;
  u.ustd=parseFloat(val("u_standard"))||0; u.ures=parseFloat(val("u_res_std"))||0; u.uzero=parseFloat(val("u_zero"))||0; u.urep=parseFloat(val("u_repeat"))||0; u.uhyst=parseFloat(val("u_hyst"))||0;
  u.U=+(2*Math.sqrt(u.ustd**2+u.ures**2+u.uzero**2+u.urep**2+u.uhyst**2)).toFixed(6);
  const acceptance=getAcceptanceLimit();
  currentJob.results=currentJob.table.map(r=>{const dev=r.dev ?? 0; const errorSpan=Math.abs(dev)+u.U; const pass=errorSpan<=acceptance; return {point:r.point,deviation:dev,U:u.U,errorSpan:+errorSpan.toFixed(6),pass, std:r.avgSTD, uuc:r.avgUUC};});
  currentJob.verdictOverall=currentJob.results.every(x=>x.pass)?"Pass":"Fail";
  currentJob.status="Completed";
  $("uncertSummary").innerHTML=`U (k=2)=<b>${fmt(u.U)}</b> | Acceptance=${acceptance} bar | ผลรวม: <span class="badge ${currentJob.verdictOverall==='Pass'?'pass':'fail'}">${currentJob.verdictOverall}</span>`;
  makeAutoAnalysis();
}

/* ===== Report & Charts ===== */
function ensureResults(){
  if(!currentJob.results?.length){
    const acc=getAcceptanceLimit();
    currentJob.results=(currentJob.table||[]).map(r=>({point:r.point,deviation:r.dev||0,U:currentJob.uncertainty.U||0,errorSpan:Math.abs(r.dev||0)+(currentJob.uncertainty.U||0),pass:(Math.abs(r.dev||0)+(currentJob.uncertainty.U||0))<=acc,std:r.avgSTD,uuc:r.avgUUC}));
  }
}
function buildResultTable(){
  const i=currentJob.instrument, unit=i.unit||"bar";
  const toBarFn = toBar[unit] || (x=>x);
  const pminBar = toBarFn(parseFloat(i.rangeMin)||0);
  const pmaxBar = toBarFn(parseFloat(i.rangeMax)||0);
  const isTX = (i.type||"").toLowerCase().includes("transmitter");

  const head = `<table class="table"><thead><tr>
    <th>Standard Reading<br>[bar] (1)</th>
    <th>UUC* Reading<br>[mA]</th>
    <th>Calculation Pressure<br>[bar] (2)</th>
    <th>Measurement Deviation<br>[bar] (2)-(1)</th>
    <th>Uncertainty<br>[bar]</th>
    <th>Result<br>[Pass/Fail]</th>
  </tr></thead><tbody>`;

  const rows = (currentJob.results||[]).map((r)=>{
    const stdBar = r.std!=null ? r.std : null;
    let uuc_mA = null, calcP_bar = null;
    if(isTX){
      uuc_mA = (r.uuc!=null ? r.uuc : null);
      if(uuc_mA!=null){
        calcP_bar = pminBar + ((uuc_mA - 4)/(20 - 4)) * (pmaxBar - pminBar);
        calcP_bar = +calcP_bar.toFixed(6);
      }
    }else{
      if(r.uuc!=null) calcP_bar = +(+r.uuc).toFixed(6);
    }
    const dev2 = (calcP_bar!=null && stdBar!=null) ? +(calcP_bar - stdBar).toFixed(6) : (r.deviation!=null? +(+r.deviation).toFixed(6) : null);
    const U = r.U!=null? +(+r.U).toFixed(6) : null;
    const pass = r.pass ? '<span class="badge pass">Pass</span>' : '<span class="badge fail">Fail</span>';
    return `<tr>
      <td>${stdBar!=null?fmt(stdBar):"-"}</td>
      <td>${isTX?(uuc_mA!=null?fmt(uuc_mA):"-"):"-"}</td>
      <td>${calcP_bar!=null?fmt(calcP_bar):"-"}</td>
      <td>${dev2!=null?fmt(dev2):"-"}</td>
      <td>${U!=null?fmt(U):"-"}</td>
      <td>${pass}</td>
    </tr>`;
  }).join("");

  $("resultTableWrap").innerHTML = head + rows + "</tbody></table>";
}
function buildReportHeader(){
  const i=currentJob.instrument, e=currentJob.environment, a=currentJob.accuracy, u=currentJob.uncertainty, s=currentJob.signature;
  // Customer & Department
  setTxt("rCustomer",currentJob.customer.company); setTxt("rCustAddr",currentJob.customer.address);
  setTxt("rPlaceCompany",currentJob.place.company); setTxt("rPlaceAddr",currentJob.place.address);

  // Cert & dates
  setTxt("rCertNo",currentJob.cert.no); setTxt("rReceived",currentJob.cert.received);
  setTxt("rCalDate",i.calDate||"—"); setTxt("rIssueDate",currentJob.cert.issue||i.calDate||"—");

  // UUC
  setTxt("rType",i.type); setTxt("rModel",i.model); setTxt("rSerial",i.serial); setTxt("rMfg",i.mfg);
  setTxt("rMeasureRange",`${i.rangeMin}–${i.rangeMax} ${i.unit}`);
  setTxt("rCalRange",`${(a.points[0]!=null)?a.points[0]:"-"} … ${(a.points[a.points.length-1]!=null)?a.points[a.points.length-1]:"-"} bar`);
  setTxt("rResolution", currentJob.standard.res!=null? currentJob.standard.res+" bar":"—");

  const acceptance=getAcceptanceLimit(); setTxt("rMPE", acceptance+" bar"); setTxt("rPlantLimit", (currentJob.limits.plant!=null? currentJob.limits.plant+" bar":"—"));
  $("rVerdict").innerHTML=`<span class="badge ${currentJob.verdictOverall==='Pass'?'pass':'fail'}">${currentJob.verdictOverall||"—"}</span>`;
  setTxt("rU",fmt(u.U));

  // Standards used
  const t=$("stdBody"); t.innerHTML="";
  const list=(currentJob.standards_used&&currentJob.standards_used.length)? currentJob.standards_used : [{
    serial: currentJob.standard.serial||"—", cert: currentJob.standard.cert||"—", calDate:"—", dueDate:"—", desc: currentJob.standard.name||"—", status:"OK"
  }];
  list.forEach(su=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${su.serial}</td><td>${su.cert}</td><td>${su.calDate}</td><td>${su.dueDate}</td><td>${su.desc}</td><td>${su.status}</td>`; t.appendChild(tr);});

  // Env
  setTxt("rAmbT",e.temp??"—"); setTxt("rAmbH",e.humid??"—"); setTxt("rAmbP",e.atm??"—");

  // Signatures
  setTxt("sigTechNameOut",s.tech.name); setTxt("sigTechTitleOut",s.tech.title); setTxt("sigTechDateOut",s.tech.date);
  setTxt("sigRevNameOut",s.rev.name); setTxt("sigRevTitleOut",s.rev.title); setTxt("sigRevDateOut",s.rev.date);
  setTxt("sigAppNameOut",s.app.name); setTxt("sigAppTitleOut",s.app.title); setTxt("sigAppDateOut",s.app.date);
}
function setTxt(id,text){ $(id).innerText=(text==null||text==="")?"—":text; }

let cAcc,cErr,cPlus,cMinus;
function buildCharts(){
  const pts=currentJob.results.map(r=>r.point);
  const devs=currentJob.results.map(r=>r.deviation||0);
  const U=currentJob.results.map(r=>r.U||0);
  const acceptance=getAcceptanceLimit();
  const FS=((toBar[currentJob.instrument.unit]||((x)=>x))(currentJob.instrument.rangeMax||0)
           - (toBar[currentJob.instrument.unit]||((x)=>x))(currentJob.instrument.rangeMin||0));
  const accLine=pts.map(()=> +((0.003*FS)).toFixed(6)); // example 0.3%FS

  if(cAcc) cAcc.destroy(); if(cErr) cErr.destroy(); if(cPlus) cPlus.destroy(); if(cMinus) cMinus.destroy();
  cAcc=new Chart($("chartAccuracy"),{type:"line",data:{labels:pts,datasets:[
      {label:"Accuracy (+/-0.3%FS)",data:accLine,borderDash:[6,6],fill:false}
  ]},options:{responsive:true}});
  cErr=new Chart($("chartError"),{type:"line",data:{labels:pts,datasets:[
      {label:"Error",data:devs}
  ]},options:{responsive:true}});
  const errPlus=devs.map((d,i)=>d+(U[i]||0));
  const errMinus=devs.map((d,i)=>d-(U[i]||0));
  cPlus=new Chart($("chartErrPlusU"),{type:"line",data:{labels:pts,datasets:[
      {label:"Error + Uncer",data:errPlus}
  ]},options:{responsive:true}});
  cMinus=new Chart($("chartErrMinusU"),{type:"line",data:{labels:pts,datasets:[
      {label:"Error - Uncer",data:errMinus}
  ]},options:{responsive:true}});

  $("aiCharts").innerHTML =
    `<ul>
      <li>เส้น +MPE / -MPE คือเกณฑ์ยอมรับ (Acceptance)</li>
      <li>จุดที่ Error ±U ทะลุเส้น MPE คือ “ไม่ผ่าน”</li>
      <li>ดูแนวโน้มความผิดพลาดและฮิสเทอรีซีสเพื่อแนะนำการชดเชย</li>
    </ul>`;
}
function makeAutoAnalysis(){
  const i=currentJob.instrument, a=currentJob.accuracy, u=currentJob.uncertainty;
  const acceptance=getAcceptanceLimit();
  const devs=currentJob.results.map(r=>r.deviation||0), pts=currentJob.results.map(r=>r.point||0);
  const overMPE=currentJob.results.filter(x=>x.errorSpan>acceptance);
  const meanDev=(devs.length? devs.reduce((a,b)=>a+b,0)/devs.length : 0);
  const hMean=(currentJob.table.map(r=>r.hyst).filter(v=>v!=null).reduce((s,v)=>s+v,0) / (currentJob.table.filter(r=>r.hyst!=null).length||1)) || 0;
  let slope=0, intercept=0; if(pts.length>1){const n=pts.length; const sx=pts.reduce((a,b)=>a+b,0), sy=devs.reduce((a,b)=>a+b,0); const sxy=pts.reduce((a,_,k)=>a+pts[k]*devs[k],0); const sx2=pts.reduce((a,b)=>a+b*b,0); const den=(n*sx2 - sx*sx)||1; slope=(n*sxy - sx*sy)/den; intercept=(sy - slope*sx)/n; }
  const lines=[];
  lines.push(`<b>สรุป</b>: ${i.type||"-"} รุ่น ${i.model||"-"} S/N ${i.serial||"-"} ช่วง ${i.rangeMin}–${i.rangeMax} ${i.unit} | Sequence ${a.seq||"-"}`);
  lines.push(`U (k=2) = ${fmt(u.U)} | MPE = ${acceptance} bar`);
  lines.push(`Deviation เฉลี่ย ≈ ${fmt(meanDev)} | Hysteresis เฉลี่ย ≈ ${fmt(hMean)} | แนวโน้ม ≈ ${fmt(slope)} bar/bar`);
  if(overMPE.length===0){lines.push(`<span class="badge pass">PASS</span> — ทุกจุดใต้ MPE`);} else {const w=overMPE.reduce((m,x)=>x.errorSpan>m.errorSpan?x:m,{errorSpan:-Infinity}); lines.push(`<span class="badge fail">FAIL</span> — เกิน MPE ${overMPE.length} จุด (แย่สุด ${fmt(w.point)} bar, Span=${fmt(w.errorSpan)})`);}
  if(currentJob.limits.enableCorrection){
    if(Math.abs(slope)<(0.02*acceptance)) lines.push(`<b>แนะนำค่าแก้ Offset</b>: c = −mean(dev) = ${fmt(-meanDev)} → Reading_corr = Reading + c`);
    else lines.push(`<b>แนะนำ Linear</b>: a=${fmt(-slope)}, b=${fmt(-intercept)} → Reading_corr = Reading + (a·Point + b)`);
  }
  $("aiNote").innerHTML=`<div>${lines.join("<br>")}</div>`;
}
function makeAICharts(){
  const pts=currentJob.results.map(r=>r.point), errs=currentJob.results.map(r=>r.errorSpan);
  const acceptance=getAcceptanceLimit();
  const crossM=pts.filter((p,i)=>errs[i]>acceptance);
  const bullets=[
    `กราฟ Accuracy: เส้นประระดับ ±Accuracy อ้างอิง FS`,
    `กราฟ Error: ตรวจแนวโน้ม/เบี่ยงเบนศูนย์`,
    `กราฟ Error+U และ Error−U: ใช้ประเมินขอบเขตความเชื่อมั่นเทียบกับเกณฑ์`,
    `จุดเกิน MPE: ${crossM.length? crossM.join(", ")+" bar":"ไม่มี"}`
  ];
  $("aiCharts").innerHTML = `<ul><li>${bullets.join("</li><li>")}</li></ul>`;
}

/* ===== Export PDF ===== */
$("btnMakePDF").addEventListener("click",async()=>{
  buildReportHeader(); ensureResults(); buildResultTable(); makeAutoAnalysis();
  const doc=new jspdf.jsPDF({unit:"pt",format:"a4"});
  const node=$("reportCard"); const canvas=await html2canvas(node,{scale:2,background:"#ffffff"});
  const img=canvas.toDataURL("image/png"); const pageW=doc.internal.pageSize.getWidth();
  const imgW=pageW-40; const imgH=canvas.height*(imgW/canvas.width);
  doc.addImage(img,"PNG",20,20,imgW,imgH); doc.save(`Calibration_${currentJob.instrument.serial||"report"}.pdf`);
});

/* ===== Export CSV (header fixed) ===== */
$("btnCSV").addEventListener("click", () => {
  const head = ","UUC","Dev[bar](2-1)","U[bar]","Result"];
  const lines = [head.join(",")];

  const i = currentJob.instrument, unit = i.unit || "bar";
  const toBarFn = toBar[unit] || (x => x);
  const pminBar = toBarFn(parseFloat(i.rangeMin) || 0);
  const pmaxBar = toBarFn(parseFloat(i.rangeMax) || 0);
  const isTX = (i.type || "").toLowerCase().includes("transmitter");

  (currentJob.results || []).forEach((r) => {
    const stdBar = r.std ?? null;
    let uuc_mA = null, calcP_bar = null;

    if (isTX) {
      uuc_mA = r.uuc ?? null;
      if (uuc_mA != null) {
        calcP_bar = pminBar + ((uuc_mA - 4) / 16) * (pmaxBar - pminBar);
        calcP_bar = +calcP_bar.toFixed(6);
      }
    } else {
      if (r.uuc != null) calcP_bar = +(+r.uuc).toFixed(6);
    }

    const dev2 = (calcP_bar != null && stdBar != null)
      ? +(calcP_bar - stdBar).toFixed(6)
      : (r.deviation != null ? +(+r.deviation).toFixed(6) : null);

    const out = [
      stdBar != null ? fmt(stdBar) : "-",
      isTX ? (uuc_mA != null ? fmt(uuc_mA) : "-") : "-",
      calcP_bar != null ? fmt(calcP_bar) : "-",
      dev2 != null ? fmt(dev2) : "-",
      r.U != null ? fmt(r.U) : "-",
      r.pass ? "PASS" : "FAIL"
    ];
    lines.push(out.join(","));
  });

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Calibration_${currentJob.instrument.serial || "data"}.csv`;
  a.click();
});

/* ===== Init ===== */
function init(){
  populateCompanyMaster();
  refreshDashboard();
  if(location.hash){const h=location.hash.slice(1); if(pages.includes(h)) switchPage(h);}
}
init();
</script>
</body>
</html>
